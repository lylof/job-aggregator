
### **PRD & Sp√©cification Technique v2.0**
### **Projet : Job Board Modulaire pour l'Afrique Francophone**

**Date:** {{ Date.now() | date }}
**Version:** 2.0
**Type:** Sp√©cification Technique et Strat√©gique

---

### **Table des Mati√®res**

1.  **R√©sum√© Ex√©cutif (Mis √† jour)**
2.  **Contexte et Objectifs (Mis √† jour)**
3.  **Architecture Globale (Mis √† jour)**
4.  **Choix Technologiques (Mis √† jour)**
5.  **Base de Donn√©es PostgreSQL (Mis √† jour)**
6.  **Cron Jobs et Ingestion (Mis √† jour)**
7.  **API Interne FastAPI (Mis √† jour)**
8.  **Cache et Optimisation**
9.  **Tests et Validation**
10. **D√©ploiement et Documentation (Mis √† jour)**
11. **Annexes et Ressources**

---

### **1. R√©sum√© Ex√©cutif (Mis √† jour)**

#### **Objectif Principal**
D√©velopper et lancer un Job Board pour l'**Afrique francophone** en utilisant une architecture 100% API, modulaire et √©volutive. Le syst√®me s'appuiera initialement sur des sources de donn√©es externes (JSearch API, flux RSS) pour constituer une base d'offres solide (Phase 1), avec l'objectif strat√©gique de transitionner vers une plateforme autonome o√π les recruteurs publient directement leurs offres (Phase 2).

#### **B√©n√©fices Attendus**
Am√©lioration des performances, **contr√¥le total des co√ªts d'infrastructure gr√¢ce √† une utilisation strat√©gique des quotas API**, et scalabilit√© automatique pour supporter la croissance future, y compris l'ajout de nouvelles cat√©gories comme les **bourses d'√©tudes**.

#### **Phases Cl√©s du Projet**
*   **Phase 1 (MVP - Lancement)** : Agr√©gation d'offres d'emploi via JSearch et potentiellement des flux RSS pour l'Afrique francophone. L'accent est mis sur la constitution rapide d'une base de donn√©es riche.
*   **Phase 2 (√âvolution - 3 √† 6 mois post-lancement)** : Activation du portail recruteur pour la publication directe, optimisation des sources de donn√©es (filtrage dynamique pour g√©rer les doublons/co√ªts), et introduction de la section "Bourses".
*   **Phase 3 (Maturit√©)** : R√©duction progressive de la d√©pendance aux agr√©gateurs externes pour devenir une plateforme leader et autonome.

#### **Points Cl√©s de l'Architecture**
*   **Sources de donn√©es multiples** : JSearch (API) et Flux RSS g√©r√©s de mani√®re flexible.
*   **Backend Modulaire** : FastAPI pour permettre l'ajout facile de nouveaux types de contenu (offres, bourses).
*   **Base de Donn√©es √âvolutive** : Sch√©ma PostgreSQL con√ßu d√®s le d√©part pour distinguer les "jobs" des "bourses".
*   **Optimisation des Co√ªts** : Synchronisation des offres limit√©e √† 2 fois par jour pour pr√©server les quotas API.

---

### **2. Contexte et Objectifs (Mis √† jour)**

#### **Situation Actuelle**
*   **Source de donn√©es principale** : L'API JSearch (via RapidAPI) est utilis√©e comme source primaire pour agr√©ger les offres d'emploi (notamment de Google for Jobs) ciblant les pays d'Afrique francophone.
*   **Sources de donn√©es secondaires** : Des flux RSS de sites d'emploi locaux (ex: `emploitogo.info`) sont identifi√©s comme sources potentielles pour enrichir ou remplacer certaines donn√©es de JSearch √† l'avenir.
*   **Syst√®me existant** : Pas de syst√®me actuel, migration depuis une id√©e vers une architecture concr√®te et phas√©e.

#### **Objectifs de Migration et de D√©veloppement**
*   **Fiabilit√©** : API professionnelle avec SLA garanti sur les sources externes.
*   **√âvolutivit√©** : Architecture serverless con√ßue pour g√©rer diff√©rents types de contenu (offres, bourses) et pour accueillir un portail recruteur.
*   **Contr√¥le des Co√ªts** : Optimisation drastique de l'usage des API payantes et utilisation du plan gratuit de Supabase.

#### **Crit√®res de Succ√®s (Mis √† jour)**
*   **Disponibilit√©** : `99.9%`
*   **Temps de r√©ponse API** : `<500ms` (P95)
*   **Synchronisation des jobs** : **`2x/jour`** (matin et soir pour √©conomiser les quotas)
*   **Co√ªt infrastructure initiale** : `0‚Ç¨`

---

### **3. Architecture Globale (Mis √† jour)**

#### **Diagramme de Flux de Donn√©es (Conceptuellement mis √† jour)**

```mermaid
graph TD
    subgraph Phase 1 & 2
        subgraph Orchestration [GitHub Actions (Cron Jobs)]
            A[Cron 2x/jour] --> B{Script d'Ingestion};
        end
        subgraph Sources Externes
            JSearch[JSearch API];
            RSS[Flux RSS (Optionnel en Phase 2)];
        end

        B --> JSearch;
        B --> RSS;

        JSearch --> C[UPSERT dans Supabase];
        RSS --> C;
    end

    subgraph Phase 2
        Recruiter[Portail Recruteur] --> API;
    end

    subgraph Exposition
        API[API Interne (FastAPI)];
        C --> API;
        Frontend[Front-end App (React/Vue/...)] --> API;
        API --> Redis[(Redis Cache - Optionnel)];
        API --> JSearchDetails[JSearch /job-details (√Ä la demande)];
    end

    style C fill:#d4edda,stroke:#155724
    style Recruiter fill:#f8d7da,stroke:#721c24
```

#### **Composants Principaux (Mis √† jour)**
*   **Cron Jobs (GitHub Actions)** : Orchestration des appels aux sources externes (API et RSS) et synchronisation des donn√©es, **optimis√©e √† 2 fois par jour**.
*   **JSearch API** : Source de donn√©es principale en Phase 1.
*   **Flux RSS** : Sources de donn√©es compl√©mentaires activables en Phase 2 pour ma√Ætriser les co√ªts et la qualit√©.
*   **Supabase PostgreSQL** : Base de donn√©es managed, avec un sch√©ma **modulaire** pour g√©rer offres et bourses.
*   **API Interne (FastAPI)** : Expose les donn√©es au front-end, avec des endpoints con√ßus pour √™tre g√©n√©riques.
*   **(Futur) Portail Recruteur** : Module √† activer en Phase 2, qui permettra la soumission d'offres directement via l'API interne.

---

### **4. Choix Technologiques (Mis √† jour)**

#### **Recommandations Finales**
*   **API Backend** : FastAPI (Python)
*   **Base de donn√©es** : Supabase PostgreSQL
*   **Cron Jobs** : GitHub Actions
*   **Cache** : Redis (optionnel)
*   **D√©ploiement** : Vercel/Railway

#### **Comparaison FastAPI vs Express**
*(Contenu original conserv√©...)*

#### **Nouvelle Section : Strat√©gie des Sources de Donn√©es**

L'architecture est con√ßue pour √™tre agnostique √† la source de donn√©es, suivant une approche phas√©e :

*   **Phase 1 (MVP - Maximiser le contenu)** :
    *   Le script d'ingestion utilise **uniquement JSearch** pour toutes les requ√™tes.
    *   M√™me si une source (ex: `job-senegal.com`) est disponible en RSS, on la r√©cup√®re via JSearch pour simplifier le MVP et maximiser le volume initial.
    *   L'objectif est de lancer la plateforme avec le plus d'offres possible.

*   **Phase 2 (Optimisation - Contr√¥le et Qualit√©)** :
    *   **Activation du filtrage dynamique** : Une liste de domaines (`excluded_sources = ['emploitogo.info', ...]`) est maintenue dans la configuration du script d'ingestion.
    *   Avant de lancer une requ√™te JSearch, le script peut filtrer les r√©sultats pour exclure les offres provenant de ces domaines.
    *   Parall√®lement, le script peut √™tre √©tendu pour parser directement les flux RSS de ces m√™mes sources.
    *   **Avantages** :
        1.  **√âconomie de quotas** : On ne "paie" pas pour des offres qu'on peut avoir gratuitement.
        2.  **Qualit√© des donn√©es** : On ma√Ætrise directement la donn√©e du flux RSS, sans passer par un interm√©diaire.
        3.  **Flexibilit√©** : Cette logique est g√©r√©e **c√¥t√© code**, sans aucune modification de la base de donn√©es. On peut activer/d√©sactiver une source RSS en modifiant une simple liste de configuration.

---

### **5. Base de Donn√©es PostgreSQL (Mis √† jour)**

#### **Sch√©ma de la Table `items_cache` (Anciennement `jobs_cache`)**
La table est renomm√©e et √©tendue pour la modularit√©.

```sql
CREATE TABLE items_cache (
    -- Cl√© primaire composite pour d√©duplication
    item_id VARCHAR(255) NOT NULL,
    item_provider VARCHAR(100) NOT NULL,

    -- NOUVEAU: Colonnes pour la modularit√© et la tra√ßabilit√©
    item_type VARCHAR(20) NOT NULL DEFAULT 'job', -- 'job', 'bourse', etc.
    source_type VARCHAR(20) NOT NULL, -- 'api', 'rss', 'direct'
    source_name VARCHAR(100), -- 'jsearch', 'emploitogo.info', 'recruteur_x'

    -- M√©tadonn√©es de synchronisation
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    item_posted_at TIMESTAMP WITH TIME ZONE,
    item_expires_at TIMESTAMP WITH TIME ZONE,

    -- Informations principales (g√©n√©riques)
    item_title VARCHAR(500),
    company_name VARCHAR(300),
    -- ... autres champs renomm√©s de 'job_' √† 'item_' ou gard√©s g√©n√©riques
    item_employment_type VARCHAR(100), -- FULLTIME, PARTTIME, CONTRACTOR
    item_is_remote BOOLEAN DEFAULT FALSE,

    -- Localisation
    item_city VARCHAR(200),
    item_state VARCHAR(100),
    item_country VARCHAR(100),
    item_latitude DECIMAL(10,8),
    item_longitude DECIMAL(11,8),

    -- Contenu
    item_description TEXT,
    item_highlights JSONB, -- qualifications, responsibilities, benefits
    -- ... autres champs
    raw_data JSONB NOT NULL, -- Backup complet de la source

    -- M√©tadonn√©es syst√®me
    sync_batch_id VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,

    -- Contraintes
    PRIMARY KEY (item_id, item_provider),
    CONSTRAINT unique_item_per_provider UNIQUE (item_id, item_provider)
);

-- NOUVEAU: Index sur le type d'item pour filtrage rapide
CREATE INDEX idx_items_cache_type ON items_cache (item_type);

-- Index sur les sources pour le d√©bogage et le filtrage
CREATE INDEX idx_items_cache_source ON items_cache (source_type, source_name);

-- (Autres index existants adapt√©s avec le nouveau nom de table/colonnes...)
```

#### **Strat√©gie de D√©duplication et d'Optimisation**
*(Contenu original conserv√©, s'applique toujours √† la nouvelle table `items_cache`)*

---

### **6. Cron Jobs et Ingestion (Mis √† jour)**

#### **Planning des Synchronisations (Mis √† jour)**
*   **Fr√©quence** : **2x par jour**
*   **Jours** : Lundi - Samedi
*   **Horaires** : **07:00, 19:00 CET** (par exemple)

#### **Configuration GitHub Actions (Mis √† jour)**
```yaml
name: Items Sync
on:
  schedule:
    # 2 fois par jour (6h et 18h UTC, soit ~7h/19h CET)
    - cron: '0 6,18 * * 1-6'
  workflow_dispatch: # Manuel trigger
```
*(Le reste de la configuration reste identique)*

#### **Script Python d'Ingestion (Logique mise √† jour)**
Le script `job_sync.py` devient `item_sync.py`.

```python
# item_sync.py

# NOUVEAU: Fichier de configuration ou variables d'environnement
# pour la strat√©gie de source
EXCLUDED_JSEARCH_SOURCES = os.environ.get('EXCLUDED_SOURCES', '').split(',')
# -> ['emploitogo.info', 'job-senegal.com']

async def sync_items(self):
    # ...
    # 1. (Optionnel en Phase 2) Lancer le parsing des flux RSS
    # rss_items = await self.fetch_from_rss(EXCLUDED_JSEARCH_SOURCES)
    # await self.upsert_items(rss_items, source_type='rss')

    # 2. Lancer la recherche via JSearch
    # La requ√™te JSearch peut √™tre modifi√©e pour exclure des sites si l'API le permet
    # ou le filtrage se fait post-r√©cup√©ration
    queries = ["developpeur afrique francophone", "marketing abidjan", ...]
    for query in queries:
        api_items = await self.fetch_jsearch_paginated(query)
        # Filtrage en post-traitement (simple et efficace)
        filtered_items = [
            item for item in api_items
            if item.get('employer_website') not in EXCLUDED_JSEARCH_SOURCES
        ]
        await self.upsert_items(filtered_items, source_type='api', source_name='jsearch')
    # ...
```
*(Le reste du script est adapt√© pour utiliser les nouveaux noms de colonnes : `item_id`, `item_type`, etc.)*

---

### **7. API Interne FastAPI (Mis √† jour)**

L'API est rendue plus g√©n√©rique pour anticiper les futures cat√©gories.

#### **Endpoints Principaux (Mis √† jour)**
*   **`GET /items`** : Remplace `GET /jobs`. Recherche et filtrage avec pagination. Accepte un nouveau param√®tre `type` (`job` ou `bourse`).
*   **`GET /items/{item_id}`** : Remplace `GET /jobs/{job_id}`.
*   **`GET /stats`** : Reste identique mais agr√®ge les donn√©es de la table `items_cache`.
*   **`POST /items` (Phase 2)** : Endpoint s√©curis√© pour les recruteurs, leur permettant de soumettre une nouvelle offre (`item_type='job'`, `source_type='direct'`).

#### **Impl√©mentation FastAPI (Extraits mis √† jour)**
```python
# main.py

# Mise √† jour des mod√®les Pydantic
class ItemSummary(BaseModel):
    item_id: str
    item_type: str # 'job' ou 'bourse'
    # ... autres champs

# Mise √† jour de l'endpoint de recherche
@app.get("/items", response_model=ItemSearchResponse)
async def search_items(
    type: str = Query('job', description="Type d'item: 'job' ou 'bourse'"),
    # ... autres param√®tres de recherche
):
    query_builder = supabase.table('items_cache').select(...)
    
    # Filtrage obligatoire par type
    query_builder = query_builder.eq('item_type', type)
    
    # ... reste de la logique de filtrage
```

---

### **8. Cache et Optimisation**
*(Contenu original enti√®rement conserv√©. Les strat√©gies de cache Redis et d'optimisation PostgreSQL sont toujours pertinentes.)*

---

### **9. Tests et Validation**
*(Contenu original enti√®rement conserv√©. Les exemples de tests Pytest doivent simplement √™tre adapt√©s aux nouveaux noms d'endpoints (`/items`) et aux nouvelles structures de donn√©es.)*

---

### **10. D√©ploiement et Documentation (Mis √† jour)**

#### **Options de D√©ploiement**
*(Contenu original conserv√©)*

#### **Variables d'Environnement**
```
# NOUVEAU: Pour la strat√©gie de source en Phase 2
EXCLUDED_SOURCES=emploitogo.info,another-site.com
```
*(Autres variables conserv√©es)*

#### **README.md Complet (Extrait mis √† jour)**

```markdown
# Job Board API v2.0 - Afrique Francophone

API modulaire pour un job board ciblant l'Afrique francophone, con√ßue pour une √©volution progressive d'un mod√®le agr√©gateur vers une plateforme autonome.

## ‚ú® Philosophie

- **Modularit√©** : L'architecture est con√ßue pour supporter plusieurs types de contenu (offres d'emploi, bourses) sans refonte majeure.
- **√âconomie de ressources** : Utilisation strat√©gique des API externes pour minimiser les co√ªts.
- **Autonomie** : L'objectif √† long terme est de ne plus d√©pendre des agr√©gateurs.

## üó∫Ô∏è Roadmap Strat√©gique

### **Phase 1 : MVP (Lancement)**
- [x] Agr√©gation d'offres d'emploi via JSearch (2x/jour).
- [x] Cible : March√©s cl√©s d'Afrique francophone (C√¥te d'Ivoire, S√©n√©gal, Cameroun...).
- [x] API de consultation (`GET /items?type=job`).

### **Phase 2 : √âvolution (3-6 mois post-lancement)**
- [ ] Activation du portail recruteur (`POST /items`).
- [ ] Int√©gration de la section "Bourses" (`GET /items?type=bourse`).
- [ ] Impl√©mentation du filtrage de sources pour optimiser les co√ªts (JSearch + RSS).

### **Phase 3 : Maturit√© (Au-del√†)**
- [ ] D√©commissionnement progressif de JSearch.
- [ ] Fonctionnalit√©s avanc√©es : alertes, profils entreprise, etc.

<!-- Le reste du README est conserv√© et adapt√© -->
```

---

### **Note finale de l'architecte**

Cette mise √† jour transforme le projet d'un simple "job board" en une **plateforme de contenu professionnel √©volutive**. Les choix cl√©s (table `items_cache` g√©n√©rique, strat√©gie de source flexible c√¥t√© code, roadmap phas√©e) garantissent que le syst√®me est non seulement **√©conomique √† lancer**, mais aussi **pr√™t pour l'avenir** sans n√©cessiter de refontes co√ªteuses. La transition vers l'autonomie est int√©gr√©e dans l'ADN m√™me de l'architecture.